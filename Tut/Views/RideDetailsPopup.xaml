<?xml version="1.0" encoding="utf-8"?>

<ContentView
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:pageModels="clr-namespace:Tut.PageModels"
    xmlns:models="clr-namespace:Tut.Common.Models;assembly=Tut_Common"
    x:Class="Tut.Views.RideDetailsPopup"
    x:DataType="pageModels:RideDetailsViewModel">

    <Border
        BackgroundColor="Transparent"
        VerticalOptions="End"
        MinimumHeightRequest="300"
        Stroke="Transparent"
        StrokeShape="RoundRectangle 10,10,0,0"
        StrokeThickness="0"
        >


        <Border.GestureRecognizers>
            <TapGestureRecognizer Tapped="HideShowContent" />
        </Border.GestureRecognizers>
        <VerticalStackLayout VerticalOptions="Start">
            <BoxView BackgroundColor="{StaticResource Gray500}" HorizontalOptions="Center"
                     WidthRequest="55" HeightRequest="4" Margin="0,10,0,10" />
            <!--Header-->
            <Grid>
                <!--before driver acceptance-->
                <Grid ColumnDefinitions="64,*,64"
                      ColumnSpacing="10"
                      IsVisible="{Binding ViewBeforeDriverAcceptingVisibility}"
                      BackgroundColor="{DynamicResource BackgroundColor}"
                      Margin="20,0"
                      Padding="10,0">
                    <Rectangle BackgroundColor="{DynamicResource BackgroundColor}"
                               Grid.ColumnSpan="3"
                               RadiusX="8"
                               RadiusY="8"
                               Margin="-10, -5" />
                    <Rectangle BackgroundColor="{DynamicResource SecondaryBackgroundColor}"
                               RadiusX="8"
                               RadiusY="8" />
                    <Image Source="{Binding CarImage}" WidthRequest="56" />
                    <StackLayout Grid.Column="1" VerticalOptions="Center" Spacing="8">
                        <Label Text="{Binding RideType}"
                               FontSize="16"
                               TextColor="{DynamicResource PrimaryTextColor}"
                               FontAttributes="Bold" />
                        <StackLayout Orientation="Horizontal" Spacing="10">
                            <Label Text="{Binding Time}"
                                   FontSize="14"
                                   TextColor="{DynamicResource SecondaryTextColor}"
                                   VerticalOptions="Center" />
                            <Label Text="•"
                                   FontSize="14"
                                   TextColor="{DynamicResource SecondaryTextColor}" />
                            <Label Text="{Binding Eta}"
                                   FontSize="14"
                                   TextColor="{DynamicResource SecondaryTextColor}" />
                        </StackLayout>
                    </StackLayout>
                    <Label Grid.Column="2"
                           Text="{Binding Price, StringFormat='{}{0} LE'}"
                           FontSize="16"
                           FontAttributes="Bold"
                           FontFamily="Helvetica"
                           TextColor="{DynamicResource PrimaryColor}"
                           VerticalOptions="Start"
                           HorizontalOptions="Center" />
                </Grid>
                <!--finding a driver-->
                <VerticalStackLayout IsVisible="{Binding FindingDriverVisibility}"
                                     Padding="20">
                    <Label Text="Ride requested"
                           FontSize="16"
                           FontAttributes="Bold"
                           TextColor="{DynamicResource PrimaryTextColor}" />
                    <Label Text="Finding drivers nearby"
                           FontSize="16"
                           TextColor="{DynamicResource PrimaryTextColor}" />
                </VerticalStackLayout>

                <!--after driver acceptance-->
                <Grid ColumnDefinitions="100,auto,100,*"
                      RowDefinitions="auto,auto"
                      ColumnSpacing="15"
                      RowSpacing="15"
                      IsVisible="{Binding ViewAfterDriverAcceptingVisibility}"
                      BackgroundColor="{DynamicResource BackgroundColor}"
                      Padding="20,10">
                    <Grid ColumnSpacing="-10"
                          ColumnDefinitions="auto,auto">
                        <Image Grid.Column="1" Source="car.png" HeightRequest="40" VerticalOptions="End" />
                        <Image Source="driver.png" HeightRequest="46" />
                    </Grid>
                    <Label Grid.Column="1"
                           VerticalOptions="Center"
                           Text="{Binding DriverName}" FontSize="16" FontAttributes="Bold"
                           TextColor="{DynamicResource PrimaryColor}" />
                    <Label Grid.Column="2"
                           VerticalOptions="Center"
                           Text="{Binding CarNumber}"
                           FontSize="12"
                           TextColor="{DynamicResource PrimaryTextColor}" />
                    <Grid Grid.Row="1" Grid.ColumnSpan="4" ColumnDefinitions="auto,*" ColumnSpacing="10">
                        <Grid.Resources>
                            <Style TargetType="Border">
                                <Setter Property="Padding" Value="10" />
                                <Setter Property="StrokeThickness" Value="0" />
                                <Setter Property="StrokeShape" Value="RoundRectangle 8" />
                                <Setter Property="BackgroundColor" Value="Black" />
                                <Setter Property="HorizontalOptions" Value="Center" />
                                <Setter Property="VerticalOptions" Value="Center" />
                            </Style>
                        </Grid.Resources>
                        <HorizontalStackLayout Spacing="10">
                            <Border>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding CallForHelpCommand}" />
                                </Border.GestureRecognizers>
                                <Image Source="call.png" WidthRequest="22" HeightRequest="22">
                                    <Image.Behaviors>
                                        <toolkit:IconTintColorBehavior TintColor="{DynamicResource SecondaryTextColor}" />
                                    </Image.Behaviors>
                                </Image>
                            </Border>
                            <Border>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding OpenChatCommand}" />
                                </Border.GestureRecognizers>
                                <HorizontalStackLayout>
                                    <Image Source="chat.png" WidthRequest="22">
                                        <Image.Behaviors>
                                            <toolkit:IconTintColorBehavior
                                                TintColor="{DynamicResource SecondaryTextColor}" />
                                        </Image.Behaviors>
                                    </Image>
                                    <Border BackgroundColor="red" StrokeShape="RoundRectangle 10"
                                            WidthRequest="5" HeightRequest="5"
                                            HorizontalOptions="Start"
                                            VerticalOptions="Start"
                                            IsVisible="{Binding IsChatStarted}" />
                                </HorizontalStackLayout>
                            </Border>
                        </HorizontalStackLayout>

                        <Border Grid.Column="1" HorizontalOptions="Fill">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding TakeSendPhotoCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="10" HorizontalOptions="Center">
                                <Image Source="camera.png" WidthRequest="22">
                                    <Image.Behaviors>
                                        <toolkit:IconTintColorBehavior TintColor="{DynamicResource SecondaryTextColor}" />
                                    </Image.Behaviors>
                                </Image>
                                <Label Text="Pickup Photo" FontSize="15"
                                       TextColor="{DynamicResource SecondaryTextColor}" />
                            </HorizontalStackLayout>
                        </Border>

                    </Grid>
                </Grid>

                <!--Title -->
                <Label Text="Ride details"
                       FontSize="16"
                       FontAttributes="Bold"
                       HorizontalOptions="Center"
                       Margin="0,20"
                       IsVisible="{Binding RideDetailsVisibility}"
                       TextColor="#000000" />
            </Grid>

            <!--Content-->
            <Grid x:Name="RideDetailsContent"
                  RowDefinitions="auto,*"
                  BackgroundColor="Transparent">
                <!--before driver acceptance-->
                <VerticalStackLayout x:Name="ViewBeforeDriverAccepting"
                                     BackgroundColor="Transparent"
                                     IsVisible="{Binding ViewBeforeDriverAcceptingVisibility}"
                                     Padding="20"
                                     Spacing="10">

                    <Border StrokeShape="RoundRectangle 8,8,8,8"
                            StrokeThickness="0"
                            HeightRequest="46"
                            BackgroundColor="{DynamicResource BackgroundColor}">
                        <Label Text="Cash"
                               TextColor="{DynamicResource PrimaryTextColor}"
                               FontSize="20"
                               FontAttributes="Bold"
                               VerticalOptions="Center"
                               Margin="10,0" />
                    </Border>

                    <Button Text="Request ride"
                            FontSize="15"
                            FontAttributes="Bold"
                            HeightRequest="46"
                            Command="{Binding RequestRideCommand}" />
                </VerticalStackLayout>

                <!--finding a driver-->
                <Grid Padding="20"
                      IsVisible="{Binding FindingDriverVisibility}">
                    <!-- Ride Details Section -->
                    <Grid RowDefinitions="*,Auto"
                          RowSpacing="10">
                        <!-- Ride Details Text -->
                        <VerticalStackLayout Grid.Column="0"
                                             Padding="10,0"
                                             Spacing="6">
                            <Border BackgroundColor="{DynamicResource BackgroundColor}"
                                    StrokeShape="RoundRectangle 8"
                                    Padding="10">
                                <VerticalStackLayout>
                                    <Label Text="Pickup"
                                           FontSize="14"
                                           TextColor="{DynamicResource SecondaryTextColor}" />
                                    <Label Text="{Binding PickupAddress}"
                                           FontSize="14"
                                           TextColor="{DynamicResource PrimaryTextColor}" />
                                </VerticalStackLayout>
                            </Border>
                            <Border BackgroundColor="{DynamicResource BackgroundColor}"
                                    StrokeShape="RoundRectangle 8"
                                    Padding="10">
                                <VerticalStackLayout>
                                    <Label Text="Drop-off"
                                           FontSize="14"
                                           TextColor="{DynamicResource SecondaryTextColor}" />
                                    <Label Text="{Binding DestinationAddress}"
                                           FontSize="14"
                                           TextColor="{DynamicResource PrimaryTextColor}" />
                                </VerticalStackLayout>
                            </Border>
                        </VerticalStackLayout>
                        <Button Grid.Row="1"
                                HeightRequest="46"
                                Text="Cancel ride"
                                Style="{StaticResource DestructiveButton}"
                                Command="{Binding CancelRideCommand}" />
                    </Grid>
                </Grid>

                <!--after driver acceptance-->
                <VerticalStackLayout Grid.Row="1"
                                     Spacing="7"
                                     Padding="0,0,0,10"
                                     BackgroundColor="{DynamicResource BackgroundColor}"
                                     IsVisible="{Binding ViewAfterDriverAcceptingVisibility}">
                    <VerticalStackLayout.Resources>
                        <Style TargetType="Label">
                            <Setter Property="FontSize" Value="16" />
                            <Setter Property="TextColor" Value="{DynamicResource PrimaryTextColor}" />
                        </Style>
                        <Style TargetType="VerticalStackLayout">
                            <Setter Property="Spacing" Value="2" />
                        </Style>
                    </VerticalStackLayout.Resources>
                    <VerticalStackLayout Spacing="10" Padding="20,15">
                        <Label Text="Ride details" FontSize="18" Margin="0,5" />
                        <VerticalStackLayout>
                            <Label Text="From" TextColor="{DynamicResource SecondaryTextColor}" />
                            <Label Text="{Binding PickupAddress}" />
                        </VerticalStackLayout>
                        <BoxView BackgroundColor="{StaticResource Gray100}" HeightRequest="0.5"
                                 HorizontalOptions="Fill" />
                        <CollectionView ItemsSource="{Binding TripPlaces}">
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:Place">
                                    <VerticalStackLayout>
                                        <Label Text="Stop" TextColor="{DynamicResource SecondaryTextColor}" />
                                        <Label Text="{Binding Address}" />
                                    </VerticalStackLayout>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                        <BoxView BackgroundColor="{StaticResource Gray100}" HeightRequest="0.5"
                                 HorizontalOptions="Fill" />
                        <VerticalStackLayout>
                            <Label Text="To" TextColor="Gray" />
                            <Label Text="{Binding DestinationAddress}" />
                        </VerticalStackLayout>
                        <BoxView BackgroundColor="{StaticResource Gray100}" HeightRequest="0.5"
                                 HorizontalOptions="Fill" />

                    </VerticalStackLayout>


                    <Grid ColumnDefinitions="*,*"
                          Padding="20,5">
                        <Label Text="Cash" FontSize="16" TextColor="{DynamicResource PrimaryTextColor}" />
                        <Label Grid.Column="1" HorizontalOptions="End">
                            <Label.FormattedText>
                                <FormattedString>
                                    <Span Text="{Binding Price, StringFormat='{}{0}LE'}"
                                          TextColor="{DynamicResource PrimaryColor}"
                                          FontSize="16"
                                          FontAttributes="Bold" />
                                </FormattedString>
                            </Label.FormattedText>
                        </Label>
                    </Grid>

                    <Grid ColumnDefinitions="*,*">
                        <Grid.Resources>
                            <Style TargetType="Border">
                                <Setter Property="Padding" Value="15,10" />
                                <Setter Property="StrokeThickness" Value="0" />
                                <Setter Property="StrokeShape" Value="RoundRectangle 20" />
                                <Setter Property="BackgroundColor" Value="Black" />
                                <Setter Property="HorizontalOptions" Value="Center" />
                            </Style>
                        </Grid.Resources>
                        <Border>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding CallForHelpCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="10">
                                <Image Source="call.png" WidthRequest="22" />
                                <Label Text="Call for help" FontSize="12"
                                       TextColor="{DynamicResource SecondaryTextColor}" />
                            </HorizontalStackLayout>
                        </Border>
                        <Border Grid.Column="1">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ChatWithSupportCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="10">
                                <Image Source="chat.png" WidthRequest="22" />
                                <Label Text="Chat with support" FontSize="12"
                                       TextColor="{DynamicResource SecondaryTextColor}" />
                            </HorizontalStackLayout>
                        </Border>
                    </Grid>
                </VerticalStackLayout>

                <!--ride details-->
                <VerticalStackLayout Padding="20" Spacing="12" IsVisible="{Binding RideDetailsVisibility}"
                                     BackgroundColor="White">
                    <StackLayout>
                        <Label Text="{Binding PickupAddress}" />
                    </StackLayout>

                    <BoxView HeightRequest="1" BackgroundColor="#E8E8E8" />
                    <!-- Destination -->
                    <StackLayout Orientation="Horizontal">
                        <VerticalStackLayout Spacing="6">
                            <Label Text="To" TextColor="#6B6B6B" />
                            <Label Text="{Binding DestinationAddress}" />
                        </VerticalStackLayout>
                        <HorizontalStackLayout HorizontalOptions="End" Spacing="3">
                            <Image Source="startimage.png" />
                            <Label Text="change" TextColor="{StaticResource Primary}" VerticalOptions="Center" />
                            <HorizontalStackLayout.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding AddStopsCommand}" />
                            </HorizontalStackLayout.GestureRecognizers>
                        </HorizontalStackLayout>
                    </StackLayout>

                    <BoxView HeightRequest="1" BackgroundColor="#E8E8E8" />

                    <!-- Service Type -->
                    <VerticalStackLayout Spacing="6">
                        <Label Text="Service type" TextColor="#6B6B6B" />
                        <Label Text="Private car" />
                    </VerticalStackLayout>

                    <Button Text="Back" Command="{Binding BackFromRideDetailsCommand}" Margin="0,50,0,0" />
                    <Button Text="Cancel request" Command="{Binding CancelRideCommand}" Margin="0,0" />
                </VerticalStackLayout>
            </Grid>
        </VerticalStackLayout>
    </Border>
</ContentView>